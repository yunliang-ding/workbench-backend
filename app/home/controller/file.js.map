{
    "version": 3,
    "sources": [
        "../../../src/home/controller/file.js"
    ],
    "names": [
        "config",
        "require",
        "dirTree",
        "uuidv1",
        "fse",
        "fs",
        "path",
        "exec",
        "toCode",
        "code",
        "newCCode",
        "i",
        "length",
        "String",
        "fromCharCode",
        "charCodeAt",
        "fromCode",
        "__before",
        "token",
        "header",
        "get",
        "User",
        "http",
        "url",
        "json",
        "isError",
        "message",
        "cookie",
        "data",
        "isloginAction",
        "loginAction",
        "post",
        "username",
        "password",
        "queryContent",
        "res",
        "_data",
        "type",
        "push",
        "concat",
        "children",
        "content",
        "readFileSync",
        "getdirsAction",
        "queryDir",
        "dir",
        "readdir",
        "err",
        "files",
        "forEach",
        "file",
        "startsWith",
        "filepath",
        "join",
        "stats",
        "statSync",
        "isDirectory",
        "name",
        "resolve",
        "error",
        "filelistAction",
        "param",
        "extensions",
        "exclude",
        "console",
        "log",
        "getfileAction",
        "readFile",
        "savefileAction",
        "existsSync",
        "exist",
        "outputFile",
        "toString",
        "newAction",
        "fileCommand",
        "deleteAction",
        "newfolderAction",
        "renameAction",
        "cmd",
        "stdout",
        "stderr",
        "split",
        "filter",
        "_stdout",
        "downloadAction",
        "slice",
        "download",
        "Base"
    ],
    "mappings": "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",
    "file": "../../../src/home/controller/file.js",
    "sourcesContent": [
        "'use strict';\nimport Base from './base.js'\nimport { User } from './user'\nconst config = require('../../../www/config.json')\nconst dirTree = require(\"directory-tree\")\nconst uuidv1 = require('uuid/v1')\nconst fse = require('fs-extra')\nconst fs = require('fs')\nconst path = require('path')\nconst { exec } = require('child_process')\nexport default class extends Base {\n  /**\n   * @return {Promise} []\n   */\n  __before() {\n    // this.header('Access-Control-Allow-Origin', this.header('origin') || '*');\n    // this.header('Access-Control-Allow-Headers', 'x-requested-with');\n    // this.header('Access-Control-Request-Method', 'GET,POST,PUT,DELETE');\n    // this.header('Access-Control-Allow-Credentials', 'true');\n    let token = this.header('Csrf-Token') || this.get('token')\n    if (User.token !== token && this.http.url !== '/file/login') {\n      this.json({\n        code: 403,\n        isError: true,\n        message: User.token === this.cookie('token') ? '无效的token' : '需要登录',\n        data: []\n      })\n    }\n  }\n  toCode = (code) => {  //加密字符串\n    let newCCode = ''\n    for (let i = 0; i < code.length; i++) {\n      newCCode += String.fromCharCode(code[i].charCodeAt() - 1)\n    }\n    return newCCode\n  }\n  fromCode = (code) => { //解密字符串\n    let newCCode = ''\n    for (let i = 0; i < code.length; i++) {\n      newCCode += String.fromCharCode(code[i].charCodeAt() + 1)\n    }\n    return newCCode\n  }\n  async isloginAction() {\n    let { token } = this.cookie()\n    this.json({\n      code: User.token !== token ? 403 : 200\n    })\n  }\n  async loginAction() {\n    const { username, password } = this.post()\n    if (username === config.username && password === config.password) {\n      User.token = uuidv1() // 生成用户的token\n      this.cookie('token', User.token, {\n        // domain: this.header('origin'),\n        // httponly: true // 只能通过http请求\n      })\n      this.json({\n        isError: false,\n        message: '登录成功'\n      })\n    } else {\n      this.json({\n        code: 403,\n        isError: true,\n        message: '需要登录'\n      })\n    }\n  }\n  async queryContent(data) {\n    let res = []\n    for (let i = 0; i < data.length; i++) {\n      let _data = data[i]\n      if (_data.type === 'directory') {\n        res.push(_data)\n        res.concat(this.queryContent(_data.children))\n      } else {\n        _data.content = fse.readFileSync(_data.path, 'utf8')\n        res.push(_data)\n      }\n    }\n    return res\n  }\n  async getdirsAction() {\n    try {\n      let queryDir = async (dir) => {\n        return new Promise(resolve => {\n          let data = []\n          fs.readdir(dir, (err, files) => {\n            files.forEach(file => {\n              if (file.startsWith('.')) return\n              let filepath = path.join(dir, file)\n              let stats = fs.statSync(filepath)\n              if (stats.isDirectory()) {\n                data.push({\n                  type: 'directory',\n                  name: file,\n                  path: filepath\n                })\n              }\n            })\n            resolve(data)\n          })\n        })\n      }\n      const data = await queryDir(this.get('dir'))\n      this.json({\n        data,\n        isError: false\n      })\n    } catch (error) {\n      this.json({\n        error,\n        isError: true\n      })\n    }\n  }\n  async filelistAction() {\n    let param = this.get('createModel') ? {\n      extensions: /\\.js|.jsx|.ts|.tsx/,\n      exclude: /node_modules|.DS_Store|.git/\n    } : {\n        exclude: /node_modules|.DS_Store/\n      }\n    try {\n      const data = dirTree(this.get('path'), param)\n      if (this.get('createModel')) {\n        data.children = await this.queryContent(data.children)\n      }\n      this.json({\n        data,\n        isError: false\n      })\n    } catch (error) {\n      console.log(error)\n      this.json({\n        error,\n        isError: false\n      })\n    }\n  }\n  async getfileAction() {\n    try {\n      const data = await fse.readFile(this.get('path'), 'utf8')\n      this.json({\n        data: this.toCode(data),\n        isError: false\n      })\n    } catch (error) {\n      console.log(error)\n      this.json({\n        error,\n        isError: true\n      })\n    }\n  }\n  async savefileAction() {\n    try {\n      const exist = await fs.existsSync(this.post('path'))\n      if (exist) {\n        fse.outputFile(this.post('path'), this.toCode(this.post('content')).toString())\n        this.json({\n          isError: false,\n        })\n      } else {\n        throw ('file is not exist')\n      }\n    } catch (error) {\n      console.log(error)\n      this.json({\n        error,\n        isError: true\n      })\n    }\n  }\n  async newAction() {\n    try {\n      const { data, isError } = await this.fileCommand(`cd ${this.post('path')};touch ${this.post('filename')}`)\n      this.json({\n        data,\n        isError\n      })\n    } catch (error) {\n      console.log(error)\n      this.json({\n        error,\n        isError: true\n      })\n    }\n  }\n  async deleteAction() {\n    try {\n      const { data, isError } = await this.fileCommand(`cd ${this.post('path')};rm -rf ${this.post('filename')}`)\n      this.json({\n        data,\n        isError\n      })\n    } catch (error) {\n      console.log(error)\n      this.json({\n        error,\n        isError: true\n      })\n    }\n  }\n  async newfolderAction() {\n    try {\n      const { data, isError } = await this.fileCommand(`cd ${this.post('path')};mkdir ${this.post('foldername')}`)\n      this.json({\n        data,\n        isError\n      })\n    } catch (error) {\n      console.log(error)\n      this.json({\n        error,\n        isError: true\n      })\n    }\n  }\n  async renameAction() {\n    try {\n      const exist = await fs.existsSync(this.post('path') + '/' + this.post('newName'))\n      console.log(this.post('path') + '/' + this.post('newName'))\n      if (!exist) {\n        const { data, isError } = await this.fileCommand(`cd ${this.post('path')};mv ${this.post('oldName')} ${this.post('newName')}`)\n        this.json({\n          data,\n          isError\n        })\n      } else {\n        throw (`${this.post('newName')} file already exists!`)\n      }\n    } catch (error) {\n      console.log(error)\n      this.json({\n        error,\n        isError: true\n      })\n    }\n  }\n  async fileCommand(cmd) {\n    try {\n      const data = await new Promise((resolve) => {\n        exec(cmd, (err, stdout, stderr) => {\n          console.log('err==>', err)\n          if (err === null) {\n            if (stderr !== \"\") {\n              stdout = stderr + stdout\n            }\n            resolve({\n              isError: false,\n              message: null,\n              data: stdout && stdout.split('\\n').filter(_stdout => {\n                return _stdout !== ''\n              }),\n              stderr\n            })\n          } else {\n            resolve({\n              isError: true,\n              message: stderr\n            })\n          }\n        })\n      })\n      return data\n    } catch (error) {\n      console.log(error)\n      return {\n        isError: true,\n        error\n      }\n    }\n  }\n  async downloadAction() {\n    let { path, type } = this.get()\n    let name = path.split('/').slice(-1)[0]\n    if (type === 'dir') {\n      // 压缩文件夹\n      await this.fileCommand(`cd ${path}; zip -r ${name}.zip ./*`)\n      path += `/${name}.zip` // 生成压缩文件\n      this.download(path, name + '.zip')\n    } else {\n      this.download(path, name)\n    }\n  }\n}\n"
    ]
}